<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Case Database Deduplication</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .duplicate-group {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 10px 0;
            padding: 15px;
            background: #f8f9fa;
        }
        .record {
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
        }
        .keep {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .delete {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .confirmation-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 5px;
            font-size: 16px;
        }
        .step {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .step h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Legal Case Database Deduplication</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> This tool will permanently delete duplicate case records from your database. 
            Always backup your database before proceeding. The system will keep the record with the most recent "Next Date" 
            and delete all older duplicates for each case number.
        </div>

        <div class="step">
            <h3>Step 1: Preview Duplicates</h3>
            <p>First, let's see what duplicate records exist in your database:</p>
            <button onclick="previewDuplicates()">üîç Preview Duplicates</button>
            <div id="previewResults"></div>
        </div>

        <div class="step">
            <h3>Step 2: Test on Small Subset</h3>
            <p>Test the deduplication logic on a small subset (3 groups) to verify it works correctly:</p>
            <button onclick="testDeduplication()">üß™ Test Deduplication</button>
            <div id="testResults"></div>
        </div>

        <div class="step">
            <h3>Step 3: Execute Deduplication</h3>
            <div class="warning">
                <strong>üö® DANGER ZONE:</strong> This will permanently delete duplicate records!
            </div>
            <p>Type <strong>CONFIRM_DELETE_DUPLICATES</strong> to enable the delete button:</p>
            <input type="text" id="confirmationInput" class="confirmation-input" 
                   placeholder="Type confirmation phrase here..." 
                   onkeyup="checkConfirmation()">
            <br>
            <button id="executeButton" class="danger" onclick="executeDeduplication()" disabled>
                üóëÔ∏è Execute Deduplication
            </button>
            <div id="executeResults"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Processing...</p>
                </div>
            `;
        }

        function formatDate(dateStr) {
            return dateStr && dateStr !== '----' && dateStr !== '-' ? dateStr : 'No date';
        }

        async function previewDuplicates() {
            showLoading('previewResults');
            
            try {
                const response = await fetch(`${API_BASE}/api/deduplicate?mode=preview`);
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <div class="success">
                            <h4>üìä Preview Results</h4>
                            <div class="stats">
                                <div class="stat-card">
                                    <div class="stat-number">${data.totalDuplicateGroups}</div>
                                    <div class="stat-label">Duplicate Groups</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${data.totalRecordsProcessed}</div>
                                    <div class="stat-label">Total Records</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${data.totalRecordsDeleted}</div>
                                    <div class="stat-label">Will Delete</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${data.totalRecordsKept}</div>
                                    <div class="stat-label">Will Keep</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (data.duplicateGroups && data.duplicateGroups.length > 0) {
                        html += '<h4>Sample Duplicate Groups (first 5):</h4>';
                        const samplesToShow = Math.min(5, data.duplicateGroups.length);
                        
                        for (let i = 0; i < samplesToShow; i++) {
                            const group = data.duplicateGroups[i];
                            html += `
                                <div class="duplicate-group">
                                    <h5>üìã Case: "${group.caseNumber}" (${group.records.length} records)</h5>
                                    <div class="record keep">
                                        ‚úÖ <strong>KEEP:</strong> Next Date: ${formatDate(group.recordsToKeep[0]['Next Date'])}, 
                                        Taluka: ${group.recordsToKeep[0].Taluka}, 
                                        Appellant: ${group.recordsToKeep[0].Appellant}
                                    </div>
                            `;
                            
                            group.recordsToDelete.forEach((record, idx) => {
                                html += `
                                    <div class="record delete">
                                        üóëÔ∏è <strong>DELETE ${idx + 1}:</strong> Next Date: ${formatDate(record['Next Date'])}, 
                                        Taluka: ${record.Taluka}, 
                                        Appellant: ${record.Appellant}
                                    </div>
                                `;
                            });
                            
                            html += '</div>';
                        }
                        
                        if (data.duplicateGroups.length > 5) {
                            html += `<p><em>... and ${data.duplicateGroups.length - 5} more duplicate groups</em></p>`;
                        }
                    }
                    
                    document.getElementById('previewResults').innerHTML = html;
                } else {
                    document.getElementById('previewResults').innerHTML = `
                        <div class="error">‚ùå Error: ${data.error}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('previewResults').innerHTML = `
                    <div class="error">‚ùå Network Error: ${error.message}</div>
                `;
            }
        }

        async function testDeduplication() {
            showLoading('testResults');
            
            try {
                const response = await fetch(`${API_BASE}/api/deduplicate?mode=test&maxGroups=3`);
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <div class="success">
                            <h4>üß™ Test Results</h4>
                            <p>Testing deduplication logic on ${data.totalDuplicateGroups} groups:</p>
                        </div>
                    `;
                    
                    if (data.duplicateGroups && data.duplicateGroups.length > 0) {
                        data.duplicateGroups.forEach((group, index) => {
                            html += `
                                <div class="duplicate-group">
                                    <h5>üìã Test Group ${index + 1}: "${group.caseNumber}"</h5>
                                    <div class="record keep">
                                        ‚úÖ <strong>WOULD KEEP:</strong> Next Date: ${formatDate(group.recordsToKeep[0]['Next Date'])}, 
                                        UID: ${group.recordsToKeep[0].uid}
                                    </div>
                            `;
                            
                            group.recordsToDelete.forEach((record, idx) => {
                                html += `
                                    <div class="record delete">
                                        üóëÔ∏è <strong>WOULD DELETE ${idx + 1}:</strong> Next Date: ${formatDate(record['Next Date'])}, 
                                        UID: ${record.uid}
                                    </div>
                                `;
                            });
                            
                            html += '</div>';
                        });
                        
                        html += '<div class="success">‚úÖ Test completed successfully! The deduplication logic is working correctly.</div>';
                    }
                    
                    document.getElementById('testResults').innerHTML = html;
                } else {
                    document.getElementById('testResults').innerHTML = `
                        <div class="error">‚ùå Error: ${data.error}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('testResults').innerHTML = `
                    <div class="error">‚ùå Network Error: ${error.message}</div>
                `;
            }
        }

        function checkConfirmation() {
            const input = document.getElementById('confirmationInput').value;
            const button = document.getElementById('executeButton');
            
            if (input === 'CONFIRM_DELETE_DUPLICATES') {
                button.disabled = false;
                button.textContent = 'üóëÔ∏è Execute Deduplication (ENABLED)';
            } else {
                button.disabled = true;
                button.textContent = 'üóëÔ∏è Execute Deduplication';
            }
        }

        async function executeDeduplication() {
            const confirmation = document.getElementById('confirmationInput').value;
            
            if (confirmation !== 'CONFIRM_DELETE_DUPLICATES') {
                alert('Please type the confirmation phrase correctly.');
                return;
            }
            
            if (!confirm('Are you absolutely sure you want to delete duplicate records? This cannot be undone!')) {
                return;
            }
            
            showLoading('executeResults');
            
            try {
                const response = await fetch(`${API_BASE}/api/deduplicate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'execute',
                        confirmationToken: 'CONFIRM_DELETE_DUPLICATES'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('executeResults').innerHTML = `
                        <div class="success">
                            <h4>üéâ Deduplication Completed Successfully!</h4>
                            <div class="stats">
                                <div class="stat-card">
                                    <div class="stat-number">${data.totalDuplicateGroups}</div>
                                    <div class="stat-label">Groups Processed</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${data.totalRecordsDeleted}</div>
                                    <div class="stat-label">Records Deleted</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${data.totalRecordsKept}</div>
                                    <div class="stat-label">Records Kept</div>
                                </div>
                            </div>
                            <p>‚úÖ Database cleanup completed! All duplicate records have been removed.</p>
                        </div>
                    `;
                    
                    // Disable the button after successful execution
                    document.getElementById('executeButton').disabled = true;
                    document.getElementById('executeButton').textContent = '‚úÖ Deduplication Completed';
                    document.getElementById('confirmationInput').disabled = true;
                } else {
                    document.getElementById('executeResults').innerHTML = `
                        <div class="error">‚ùå Error: ${data.error}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('executeResults').innerHTML = `
                    <div class="error">‚ùå Network Error: ${error.message}</div>
                `;
            }
        }
    </script>
</body>
</html>
